# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- updating

variables:
  # Global Application Variables
  vmImageName: 'macOS-10.14'
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  BuildNum: '$(Build.BuildNumber)'

stages:
- stage: SetupDependencies
  displayName: Setup Dependencies
  jobs:
  - job: SetupDependenciesJob
    displayName: Setup Dependencies Job
    pool:
      vmImage: $(vmImageName)
    steps:
    - bash: |
        echo "Installing Common  Depndencies"
        sudo npm install -g n
        sudo n stable
        npm install -g appium
        npm install -g allure-commandline --save-dev
      displayName: 'Install Common  Depndencies'
    - task: Bash@3
      inputs:
        filePath: 'script/setup.sh'
      displayName: 'Install Emulator'
    - task: Cache@2
      inputs:
        key: '"funcs" | maven |"$(Agent.OS)" | **/pom.xml'
        restoreKeys: |
        path: $(MAVEN_CACHE_FOLDER)
      displayName: Cache Maven local repo
    - task: MavenAuthenticate@0
      displayName: Authenticate Maven to Artifacts feed
      inputs:
        artifactsFeeds: artifacts-maven
    - task: Maven@3
      inputs:
        mavenPomFile: '$(System.DefaultWorkingDirectory)/attendanceApp/pom.xml'
        options: '-DsuiteXmlFile=Parallel -DdeviceName1=google -Dudid1="emulator-5556" -DdeviceName2=nexus -Dudid2="emulator-5554"'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: 'JDKVersion'
        mavenVersionOption: 'Default'
        mavenAuthenticateFeed: false
        effectivePomSkip: false
        sonarQubeRunAnalysis: false
    - bash: |
        allure generate $(System.DefaultWorkingDirectory)/attendanceApp/target/allure-results --clean -o $(System.DefaultWorkingDirectory)/attendanceApp/target/allure-report
      displayName: Generate allure report
    - publish: $(System.DefaultWorkingDirectory)/attendanceApp/target/surefire-reports/emailable-report.html
      artifact: report

      